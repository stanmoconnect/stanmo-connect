<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Provider Dashboard ‚Äî Stanmo Connect</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --orange: #F47B20;
      --dark: #0d1117;
      --card: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --green: #3fb950;
      --yellow: #d29922;
      --blue: #388bfd;
      --red: #f85149;
    }
    body { background: var(--dark); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; }
    nav {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-logo { font-family: 'Syne', sans-serif; font-weight: 800; color: var(--orange); font-size: 1.2rem; text-decoration: none; }
    .nav-right { display: flex; align-items: center; gap: 1rem; }
    .nav-name { font-size: 0.85rem; color: var(--muted); }
    .btn-logout { background: transparent; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; padding: 0.4rem 0.9rem; font-size: 0.8rem; cursor: pointer; font-family: 'DM Sans', sans-serif; }

    main { padding: 2rem 1.5rem; max-width: 900px; margin: 0 auto; }
    h1 { font-family: 'Syne', sans-serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem; }
    .welcome-sub { color: var(--muted); font-size: 0.9rem; margin-bottom: 2rem; }

    /* Subscription alert */
    .sub-alert {
      background: rgba(248,81,73,0.1);
      border: 1px solid rgba(248,81,73,0.3);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .sub-alert.active {
      background: rgba(63,185,80,0.08);
      border-color: rgba(63,185,80,0.25);
    }
    .sub-alert-text { font-size: 0.88rem; }
    .sub-alert-text strong { display: block; margin-bottom: 0.2rem; }
    .btn-renew {
      background: var(--orange);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      font-family: 'Syne', sans-serif;
    }

    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
    .stat-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .stat-value { font-family: 'Syne', sans-serif; font-size: 1.6rem; font-weight: 700; }
    .stat-value.orange { color: var(--orange); }
    .stat-value.green { color: var(--green); }
    .stat-value.blue { color: var(--blue); }

    .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; margin-top: 2rem; }
    .section-title { font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700; }

    .job-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; }
    .job-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
    .job-title { font-weight: 600; font-size: 0.95rem; }
    .badge { font-size: 0.72rem; font-weight: 600; padding: 0.25rem 0.7rem; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.04em; }
    .badge-pending { background: rgba(210,153,34,0.15); color: var(--yellow); }
    .badge-active { background: rgba(244,123,32,0.15); color: var(--orange); }
    .badge-completed { background: rgba(63,185,80,0.15); color: var(--green); }

    .job-meta { font-size: 0.82rem; color: var(--muted); margin-bottom: 0.75rem; }
    .job-meta span { margin-right: 1rem; }

    .requester-box {
      background: rgba(56,139,253,0.06);
      border: 1px solid rgba(56,139,253,0.15);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
    }
    .requester-box .r-label { font-size: 0.75rem; color: var(--blue); font-weight: 600; margin-bottom: 0.4rem; }
    .requester-box .r-name { font-weight: 600; font-size: 0.9rem; }
    .requester-box .r-phone { font-size: 0.85rem; color: var(--muted); }

    .job-actions { display: flex; gap: 0.75rem; margin-top: 0.75rem; flex-wrap: wrap; }
    .btn-quote {
      background: var(--blue);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.55rem 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
    }
    .btn-confirm {
      background: var(--green);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.55rem 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
    }
    .btn-whatsapp {
      background: #25D366;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.55rem 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      text-decoration: none;
      display: inline-block;
    }

    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--muted); }
    .empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; padding: 1rem; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; width: 100%; max-width: 440px; }
    .modal h2 { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 700; margin-bottom: 1.25rem; }
    .modal .form-group { margin-bottom: 1rem; }
    .modal label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.4rem; }
    .modal input, .modal textarea { width: 100%; background: var(--dark); border: 1px solid var(--border); border-radius: 8px; color: var(--text); padding: 0.75rem 1rem; font-size: 0.9rem; font-family: 'DM Sans', sans-serif; outline: none; }
    .modal input:focus, .modal textarea:focus { border-color: var(--orange); }
    .modal textarea { resize: vertical; min-height: 80px; }
    .modal-actions { display: flex; gap: 0.75rem; margin-top: 1.25rem; }
    .btn-primary { background: var(--orange); color: #fff; border: none; border-radius: 8px; padding: 0.7rem 1.2rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; font-family: 'Syne', sans-serif; flex: 1; }
    .btn-outline { background: transparent; color: var(--muted); border: 1px solid var(--border); border-radius: 8px; padding: 0.7rem 1.2rem; font-size: 0.9rem; cursor: pointer; font-family: 'DM Sans', sans-serif; flex: 1; }

    .earnings-box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .earnings-title { font-family: 'Syne', sans-serif; font-weight: 700; margin-bottom: 1rem; }
    .earnings-row { display: flex; justify-content: space-between; font-size: 0.88rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
    .earnings-row:last-child { border-bottom: none; }
    .earnings-row .label { color: var(--muted); }
    .earnings-row .value { font-weight: 600; }
    .earnings-row .value.green { color: var(--green); }

    @media (max-width: 600px) {
      .stats { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<nav>
  <a class="nav-logo" href="index.html">SC STANMO CONNECT</a>
  <div class="nav-right">
    <span class="nav-name" id="nav-name">Loading...</span>
    <button class="btn-logout" id="logout-btn">Logout</button>
  </div>
</nav>

<main>
  <h1 id="welcome-title">Provider Dashboard üîß</h1>
  <p class="welcome-sub">Manage your jobs and track your earnings.</p>

  <div id="sub-alert-container"></div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">New Requests</div>
      <div class="stat-value orange" id="stat-new">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Active Jobs</div>
      <div class="stat-value blue" id="stat-active">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Completed</div>
      <div class="stat-value green" id="stat-completed">0</div>
    </div>
  </div>

  <div class="section-header">
    <span class="section-title">Incoming Requests</span>
  </div>
  <div id="jobs-container">
    <div class="empty-state"><div class="empty-icon">üì≠</div><p>No requests yet. They'll appear here when requesters match your category.</p></div>
  </div>

  <div class="section-header" style="margin-top:2.5rem">
    <span class="section-title">Earnings Summary</span>
  </div>
  <div class="earnings-box">
    <div class="earnings-row"><span class="label">Total Jobs Completed</span><span class="value" id="earn-jobs">0</span></div>
    <div class="earnings-row"><span class="label">Gross Earnings</span><span class="value" id="earn-gross">‚Ç¶0</span></div>
    <div class="earnings-row"><span class="label">Platform Commission (10%)</span><span class="value" id="earn-commission">‚Ç¶0</span></div>
    <div class="earnings-row"><span class="label">Net Earnings</span><span class="value green" id="earn-net">‚Ç¶0</span></div>
  </div>
</main>

<!-- Quote Modal -->
<div class="modal-overlay" id="quote-modal">
  <div class="modal">
    <h2>üí¨ Send a Quote</h2>
    <div class="form-group">
      <label>Your Quote Amount (‚Ç¶)</label>
      <input type="number" id="quote-amount" placeholder="Enter amount in Naira" />
    </div>
    <div class="form-group">
      <label>Note to Requester (optional)</label>
      <textarea id="quote-note" placeholder="Any details about your quote..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-primary" onclick="submitQuote()">Send Quote</button>
      <button class="btn-outline" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, where, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCckKrwsUd9oyHh_w5E06S5fVYCgEDhHeA",
    authDomain: "stanmo-connect.firebaseapp.com",
    projectId: "stanmo-connect",
    storageBucket: "stanmo-connect.firebasestorage.app",
    messagingSenderId: "1030645380559",
    appId: "1:1030645380559:web:8b1385e0b6f2d90badceba"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let userData = null;
  let activeQuoteJobId = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = 'login.html'; return; }
    currentUser = user;
    const snap = await getDoc(doc(db, 'users', user.uid));
    if (!snap.exists() || snap.data().role !== 'provider') { window.location.href = 'login.html'; return; }
    userData = snap.data();
    document.getElementById('nav-name').textContent = userData.fullname;
    document.getElementById('welcome-title').textContent = `Welcome, ${userData.fullname.split(' ')[0]} üîß`;

    // Subscription alert
    const subContainer = document.getElementById('sub-alert-container');
    if (userData.subscriptionActive) {
      const expiry = userData.subscriptionExpiry ? new Date(userData.subscriptionExpiry.seconds * 1000).toLocaleDateString() : 'Active';
      subContainer.innerHTML = `<div class="sub-alert active"><div class="sub-alert-text"><strong>‚úÖ Subscription Active</strong>Your profile is visible to requesters. Renews on ${expiry}</div></div>`;
    } else {
      subContainer.innerHTML = `<div class="sub-alert"><div class="sub-alert-text"><strong>‚ö†Ô∏è Subscription Inactive</strong>Your profile is hidden. Pay ‚Ç¶3,000/month to activate.</div><button class="btn-renew" onclick="paySubscription()">Pay ‚Ç¶3,000</button></div>`;
    }

    loadJobs();
  });

  function loadJobs() {
    // Load jobs matching provider's category
    const q = query(collection(db, 'jobs'), where('category', '==', userData.category));
    onSnapshot(q, (snap) => {
      const jobs = [];
      snap.forEach(d => jobs.push({ id: d.id, ...d.data() }));
      jobs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

      // My jobs (quoted/active/completed by me)
      const myJobs = jobs.filter(j => j.providerId === currentUser.uid);
      // Available jobs (pending, not yet taken)
      const availableJobs = jobs.filter(j => j.status === 'pending' && !j.providerId);

      const allVisible = [...myJobs, ...availableJobs.filter(j => !myJobs.find(m => m.id === j.id))];

      document.getElementById('stat-new').textContent = availableJobs.length;
      document.getElementById('stat-active').textContent = myJobs.filter(j => j.status === 'active').length;
      document.getElementById('stat-completed').textContent = myJobs.filter(j => j.status === 'completed').length;

      // Earnings
      const completed = myJobs.filter(j => j.status === 'completed');
      const gross = completed.reduce((sum, j) => sum + (j.quoteAmount || 0), 0);
      const commission = completed.reduce((sum, j) => sum + (j.commission || 0), 0);
      document.getElementById('earn-jobs').textContent = completed.length;
      document.getElementById('earn-gross').textContent = `‚Ç¶${gross.toLocaleString()}`;
      document.getElementById('earn-commission').textContent = `‚Ç¶${commission.toLocaleString()}`;
      document.getElementById('earn-net').textContent = `‚Ç¶${(gross - commission).toLocaleString()}`;

      renderJobs(allVisible);
    });
  }

  function renderJobs(jobs) {
    const container = document.getElementById('jobs-container');
    if (jobs.length === 0) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><p>No requests yet.</p></div>`;
      return;
    }

    container.innerHTML = jobs.map(job => {
      const isMyJob = job.providerId === currentUser.uid;
      const badgeMap = { pending: 'badge-pending', quoted: 'badge-active', active: 'badge-active', completed: 'badge-completed' };
      const labelMap = { pending: 'Available', quoted: 'Quote Sent', active: 'In Progress', completed: 'Completed' };

      let actionsHtml = '';
      if (job.status === 'pending' && !job.providerId) {
        actionsHtml = `<div class="job-actions"><button class="btn-quote" onclick="openQuoteModal('${job.id}')">üí¨ Send Quote</button></div>`;
      }
      if (isMyJob && job.status === 'active') {
        actionsHtml = `<div class="job-actions">
          <button class="btn-confirm" onclick="confirmComplete('${job.id}')">‚úÖ Mark as Complete</button>
          <a class="btn-whatsapp" href="https://wa.me/234${job.requesterPhone?.replace(/^0/, '')}" target="_blank">üí¨ WhatsApp</a>
        </div>`;
      }
      if (isMyJob && job.status === 'quoted') {
        actionsHtml = `<div class="job-actions"><div style="font-size:0.82rem;color:var(--muted)">‚è≥ Waiting for requester to accept and pay...</div></div>`;
      }

      return `
        <div class="job-card">
          <div class="job-header">
            <span class="job-title">${job.category}</span>
            <span class="badge ${badgeMap[job.status] || 'badge-pending'}">${isMyJob ? (labelMap[job.status] || 'Pending') : 'Available'}</span>
          </div>
          <div class="job-meta">
            <span>üìç ${job.location}</span>
            <span>üìÖ ${job.createdAt ? new Date(job.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}</span>
          </div>
          <div style="font-size:0.88rem;color:var(--muted);margin-bottom:0.5rem">${job.description}</div>
          ${isMyJob && job.status !== 'pending' ? `
          <div class="requester-box">
            <div class="r-label">üë§ Requester Details</div>
            <div class="r-name">${job.requesterName}</div>
            <div class="r-phone">üìû ${job.requesterPhone}</div>
          </div>` : ''}
          ${isMyJob && job.quoteAmount ? `<div style="font-size:0.88rem;color:var(--orange);font-weight:600">Quote: ‚Ç¶${job.quoteAmount.toLocaleString()}</div>` : ''}
          ${actionsHtml}
        </div>`;
    }).join('');
  }

  window.openQuoteModal = (jobId) => {
    activeQuoteJobId = jobId;
    document.getElementById('quote-modal').classList.add('open');
  };
  window.closeModal = () => {
    document.getElementById('quote-modal').classList.remove('open');
    activeQuoteJobId = null;
  };

  window.submitQuote = async () => {
    const amount = parseFloat(document.getElementById('quote-amount').value);
    const note = document.getElementById('quote-note').value.trim();
    if (!amount || amount <= 0) { alert('Please enter a valid quote amount.'); return; }

    try {
      await updateDoc(doc(db, 'jobs', activeQuoteJobId), {
        status: 'quoted',
        quoteAmount: amount,
        quoteNote: note,
        providerId: currentUser.uid,
        providerName: userData.fullname,
        providerPhone: userData.phone,
        quotedAt: serverTimestamp()
      });
      closeModal();
      document.getElementById('quote-amount').value = '';
      document.getElementById('quote-note').value = '';
    } catch (e) { alert('Error sending quote. Please try again.'); }
  };

  window.confirmComplete = async (jobId) => {
    if (confirm('Confirm that this job has been completed?')) {
      await updateDoc(doc(db, 'jobs', jobId), { providerConfirmed: true });
      const jobSnap = await getDoc(doc(db, 'jobs', jobId));
      const jobData = jobSnap.data();
      if (jobData.requesterConfirmed) {
        const commission = Math.round(jobData.quoteAmount * 0.1);
        await updateDoc(doc(db, 'jobs', jobId), {
          status: 'completed',
          completedAt: serverTimestamp(),
          commission
        });
      }
    }
  };

  window.paySubscription = () => {
    alert('Paystack subscription payment for ‚Ç¶3,000/month will be integrated here.');
    // TODO: Integrate Paystack subscription
  };

  document.getElementById('logout-btn').addEventListener('click', () => {
    signOut(auth).then(() => window.location.href = 'login.html');
  });
</script>
</body>
</html>
