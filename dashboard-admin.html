<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard ‚Äî Stanmo Connect</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --orange: #F47B20;
      --dark: #0d1117;
      --card: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --green: #3fb950;
      --yellow: #d29922;
      --blue: #388bfd;
      --red: #f85149;
    }
    body { background: var(--dark); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; }
    nav { background: var(--card); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; }
    .nav-logo { font-family: 'Syne', sans-serif; font-weight: 800; color: var(--orange); font-size: 1.2rem; text-decoration: none; }
    .nav-badge { background: rgba(244,123,32,0.15); color: var(--orange); border-radius: 6px; padding: 0.2rem 0.7rem; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem; }
    .btn-logout { background: transparent; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; padding: 0.4rem 0.9rem; font-size: 0.8rem; cursor: pointer; font-family: 'DM Sans', sans-serif; }

    main { padding: 2rem 1.5rem; max-width: 1000px; margin: 0 auto; }
    h1 { font-family: 'Syne', sans-serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem; }
    .welcome-sub { color: var(--muted); font-size: 0.9rem; margin-bottom: 2rem; }

    /* Revenue cards */
    .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; }
    @media(min-width:600px){ .stats { grid-template-columns: repeat(4, 1fr); } }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
    .stat-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .stat-value { font-family: 'Syne', sans-serif; font-size: 1.5rem; font-weight: 700; }
    .stat-value.orange { color: var(--orange); }
    .stat-value.green { color: var(--green); }
    .stat-value.blue { color: var(--blue); }
    .stat-value.yellow { color: var(--yellow); }

    /* Tabs */
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .tab { background: transparent; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; padding: 0.5rem 1.1rem; font-size: 0.85rem; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
    .tab.active { background: var(--orange); border-color: var(--orange); color: #fff; font-weight: 600; }

    /* Table-like job cards */
    .job-row { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.1rem 1.25rem; margin-bottom: 0.75rem; }
    .job-row-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.6rem; flex-wrap: wrap; gap: 0.5rem; }
    .job-category { font-weight: 600; font-size: 0.92rem; }
    .badge { font-size: 0.72rem; font-weight: 600; padding: 0.25rem 0.7rem; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.04em; }
    .badge-pending { background: rgba(210,153,34,0.15); color: var(--yellow); }
    .badge-quoted { background: rgba(56,139,253,0.15); color: var(--blue); }
    .badge-active { background: rgba(244,123,32,0.15); color: var(--orange); }
    .badge-completed { background: rgba(63,185,80,0.15); color: var(--green); }

    .job-row-body { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.83rem; color: var(--muted); }
    .job-row-body .field strong { color: var(--text); display: block; font-size: 0.85rem; }

    .commission-box { display: inline-block; background: rgba(63,185,80,0.1); border: 1px solid rgba(63,185,80,0.2); border-radius: 6px; padding: 0.2rem 0.6rem; font-size: 0.82rem; color: var(--green); font-weight: 600; margin-top: 0.5rem; }

    /* Provider list */
    .provider-row { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.1rem 1.25rem; margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; }
    .provider-info .p-name { font-weight: 600; margin-bottom: 0.2rem; }
    .provider-info .p-meta { font-size: 0.82rem; color: var(--muted); }
    .provider-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .btn-verify { background: var(--green); color: #fff; border: none; border-radius: 7px; padding: 0.45rem 0.9rem; font-size: 0.8rem; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif; }
    .btn-suspend { background: transparent; color: var(--red); border: 1px solid var(--red); border-radius: 7px; padding: 0.45rem 0.9rem; font-size: 0.8rem; cursor: pointer; font-family: 'DM Sans', sans-serif; }
    .btn-activate { background: var(--orange); color: #fff; border: none; border-radius: 7px; padding: 0.45rem 0.9rem; font-size: 0.8rem; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif; }

    .sub-status { font-size: 0.75rem; font-weight: 600; padding: 0.2rem 0.6rem; border-radius: 20px; }
    .sub-active { background: rgba(63,185,80,0.1); color: var(--green); }
    .sub-inactive { background: rgba(248,81,73,0.1); color: var(--red); }

    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--muted); }
    .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

    /* Admin setup note */
    .setup-note { background: rgba(56,139,253,0.08); border: 1px solid rgba(56,139,253,0.2); border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; font-size: 0.85rem; color: var(--blue); }
  </style>
</head>
<body>

<nav>
  <div>
    <a class="nav-logo" href="index.html">SC STANMO CONNECT</a>
    <span class="nav-badge">ADMIN</span>
  </div>
  <button class="btn-logout" id="logout-btn">Logout</button>
</nav>

<main>
  <h1>Admin Dashboard üìä</h1>
  <p class="welcome-sub">Full overview of Stanmo Connect operations.</p>

  <div class="setup-note">
    ‚ÑπÔ∏è <strong>Setup note:</strong> To make yourself admin, go to Firestore Database ‚Üí users ‚Üí find your user document ‚Üí change <code>role</code> field to <code>"admin"</code>.
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">Total Commission</div>
      <div class="stat-value green" id="stat-commission">‚Ç¶0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Subscriptions</div>
      <div class="stat-value orange" id="stat-subscriptions">‚Ç¶0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Jobs</div>
      <div class="stat-value blue" id="stat-jobs">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Active Providers</div>
      <div class="stat-value yellow" id="stat-providers">0</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="showTab('jobs')">All Jobs</button>
    <button class="tab" onclick="showTab('providers')">Providers</button>
    <button class="tab" onclick="showTab('requesters')">Requesters</button>
  </div>

  <div id="tab-jobs">
    <div id="jobs-container"><div class="empty-state"><div class="empty-icon">üìã</div><p>Loading jobs...</p></div></div>
  </div>

  <div id="tab-providers" style="display:none">
    <div id="providers-container"><div class="empty-state"><div class="empty-icon">üîß</div><p>Loading providers...</p></div></div>
  </div>

  <div id="tab-requesters" style="display:none">
    <div id="requesters-container"><div class="empty-state"><div class="empty-icon">üë§</div><p>Loading requesters...</p></div></div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, where, onSnapshot, updateDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCckKrwsUd9oyHh_w5E06S5fVYCgEDhHeA",
    authDomain: "stanmo-connect.firebaseapp.com",
    projectId: "stanmo-connect",
    storageBucket: "stanmo-connect.firebasestorage.app",
    messagingSenderId: "1030645380559",
    appId: "1:1030645380559:web:8b1385e0b6f2d90badceba"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = 'login.html'; return; }
    const snap = await getDoc(doc(db, 'users', user.uid));
    if (!snap.exists() || snap.data().role !== 'admin') { window.location.href = 'login.html'; return; }
    loadAll();
  });

  function loadAll() {
    // Jobs
    onSnapshot(collection(db, 'jobs'), (snap) => {
      const jobs = [];
      snap.forEach(d => jobs.push({ id: d.id, ...d.data() }));
      jobs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

      const totalCommission = jobs.filter(j => j.status === 'completed').reduce((s, j) => s + (j.commission || 0), 0);
      document.getElementById('stat-commission').textContent = `‚Ç¶${totalCommission.toLocaleString()}`;
      document.getElementById('stat-jobs').textContent = jobs.length;

      renderJobs(jobs);
    });

    // Users
    onSnapshot(collection(db, 'users'), (snap) => {
      const users = [];
      snap.forEach(d => users.push({ id: d.id, ...d.data() }));

      const providers = users.filter(u => u.role === 'provider');
      const requesters = users.filter(u => u.role === 'requester');
      const activeProviders = providers.filter(p => p.subscriptionActive);

      document.getElementById('stat-providers').textContent = activeProviders.length;
      document.getElementById('stat-subscriptions').textContent = `‚Ç¶${(activeProviders.length * 3000).toLocaleString()}`;

      renderProviders(providers);
      renderRequesters(requesters);
    });
  }

  function renderJobs(jobs) {
    const container = document.getElementById('jobs-container');
    if (!jobs.length) { container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><p>No jobs yet.</p></div>`; return; }

    const badgeMap = { pending: 'badge-pending', quoted: 'badge-quoted', active: 'badge-active', completed: 'badge-completed' };
    const labelMap = { pending: 'Pending', quoted: 'Quoted', active: 'Active', completed: 'Completed' };

    container.innerHTML = jobs.map(job => `
      <div class="job-row">
        <div class="job-row-header">
          <span class="job-category">${job.category}</span>
          <span class="badge ${badgeMap[job.status] || 'badge-pending'}">${labelMap[job.status] || 'Pending'}</span>
        </div>
        <div class="job-row-body">
          <div class="field"><span>Requester</span><strong>${job.requesterName || '‚Äî'}</strong></div>
          <div class="field"><span>Provider</span><strong>${job.providerName || 'Not assigned'}</strong></div>
          <div class="field"><span>Location</span><strong>${job.location}</strong></div>
          <div class="field"><span>Date</span><strong>${job.createdAt ? new Date(job.createdAt.seconds * 1000).toLocaleDateString() : '‚Äî'}</strong></div>
        </div>
        ${job.status === 'completed' ? `<div class="commission-box">Commission Earned: ‚Ç¶${(job.commission || 0).toLocaleString()}</div>` : ''}
        ${job.quoteAmount ? `<div style="font-size:0.82rem;color:var(--muted);margin-top:0.4rem">Job Value: ‚Ç¶${job.quoteAmount.toLocaleString()}</div>` : ''}
      </div>`).join('');
  }

  function renderProviders(providers) {
    const container = document.getElementById('providers-container');
    if (!providers.length) { container.innerHTML = `<div class="empty-state"><div class="empty-icon">üîß</div><p>No providers yet.</p></div>`; return; }

    container.innerHTML = providers.map(p => `
      <div class="provider-row">
        <div class="provider-info">
          <div class="p-name">${p.fullname} ${p.verified ? '‚úÖ' : ''}</div>
          <div class="p-meta">${p.businessname || ''} ¬∑ ${p.category || ''} ¬∑ ${p.location || ''}</div>
          <div class="p-meta">üìû ${p.phone} ¬∑ ‚úâÔ∏è ${p.email}</div>
          <span class="sub-status ${p.subscriptionActive ? 'sub-active' : 'sub-inactive'}">${p.subscriptionActive ? '‚úÖ Subscription Active' : '‚ùå No Subscription'}</span>
        </div>
        <div class="provider-actions">
          ${!p.verified ? `<button class="btn-verify" onclick="verifyProvider('${p.id}')">Verify</button>` : ''}
          ${!p.subscriptionActive ? `<button class="btn-activate" onclick="activateSubscription('${p.id}')">Activate Sub</button>` : ''}
          <button class="btn-suspend" onclick="suspendProvider('${p.id}')">Suspend</button>
        </div>
      </div>`).join('');
  }

  function renderRequesters(requesters) {
    const container = document.getElementById('requesters-container');
    if (!requesters.length) { container.innerHTML = `<div class="empty-state"><div class="empty-icon">üë§</div><p>No requesters yet.</p></div>`; return; }

    container.innerHTML = requesters.map(r => `
      <div class="provider-row">
        <div class="provider-info">
          <div class="p-name">${r.fullname}</div>
          <div class="p-meta">üìç ${r.location || ''} ¬∑ üìû ${r.phone} ¬∑ ‚úâÔ∏è ${r.email}</div>
          <div class="p-meta">Joined: ${r.createdAt ? new Date(r.createdAt.seconds * 1000).toLocaleDateString() : '‚Äî'}</div>
        </div>
      </div>`).join('');
  }

  window.verifyProvider = async (uid) => {
    if (confirm('Mark this provider as verified?')) {
      await updateDoc(doc(db, 'users', uid), { verified: true, profileVisible: true });
    }
  };

  window.activateSubscription = async (uid) => {
    const expiry = new Date();
    expiry.setMonth(expiry.getMonth() + 1);
    await updateDoc(doc(db, 'users', uid), {
      subscriptionActive: true,
      subscriptionExpiry: expiry,
      profileVisible: true
    });
    alert('Subscription activated for 1 month.');
  };

  window.suspendProvider = async (uid) => {
    if (confirm('Suspend this provider? Their profile will be hidden.')) {
      await updateDoc(doc(db, 'users', uid), { profileVisible: false, subscriptionActive: false });
    }
  };

  window.showTab = (tab) => {
    ['jobs', 'providers', 'requesters'].forEach(t => {
      document.getElementById(`tab-${t}`).style.display = t === tab ? 'block' : 'none';
    });
    document.querySelectorAll('.tab').forEach((el, i) => {
      el.classList.toggle('active', ['jobs', 'providers', 'requesters'][i] === tab);
    });
  };

  document.getElementById('logout-btn').addEventListener('click', () => {
    signOut(auth).then(() => window.location.href = 'login.html');
  });
</script>
</body>
</html>
